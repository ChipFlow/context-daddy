name: Test Hook Execution

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  check-secrets:
    name: Check if API key available
    runs-on: ubuntu-latest
    outputs:
      has-api-key: ${{ steps.check.outputs.has-api-key }}
    steps:
      - name: Check for API key
        id: check
        env:
          HAS_KEY: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        run: |
          if [ "$HAS_KEY" = "true" ]; then
            echo "has-api-key=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-api-key=false" >> "$GITHUB_OUTPUT"
            echo "⚠️  ANTHROPIC_API_KEY not set - skipping E2E hook tests"
          fi

  test-hooks:
    name: E2E Hook Execution Test
    runs-on: ubuntu-latest
    needs: check-secrets
    if: ${{ needs.check-secrets.outputs.has-api-key == 'true' }}
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Create test project
        run: |
          mkdir -p test-hook-project
          cd test-hook-project

          # Create simple Python file
          cat > main.py << 'EOF'
          """Main module."""
          def hello():
              print("Hello, world!")

          if __name__ == "__main__":
              hello()
          EOF

          # Create CLAUDE.md with project info
          mkdir -p .claude
          cat > .claude/CLAUDE.md << 'EOF'
          # Test Project

          This is a test project for hook execution testing.

          ## Important
          - If you see this after compaction, hooks worked!
          - The Stop hook should force you to read this file.
          EOF

          # Create learnings.md
          cat > .claude/learnings.md << 'EOF'
          # Learnings

          ## Initial Setup (2026-01-16)
          - Test project created for hook testing
          - This file should be read after compaction
          EOF

      - name: Test SessionStart hook
        run: |
          cd test-hook-project
          echo "=== Testing SessionStart hook ==="

          # Run Claude with plugin, simple task to trigger session start
          # The SessionStart hook outputs JSON with systemMessage that goes to Claude's context
          # (not directly printed to stdout), so we verify via artifacts instead
          claude --plugin-dir ${{ github.workspace }} \
            -p "Say hello and describe what context you have about this project. Use exactly one turn." \
            --max-turns 1 \
            2>&1 | tee session-start-output.txt

          echo "Claude output:"
          cat session-start-output.txt

          # Check if manifest was created (primary indicator that SessionStart hook ran)
          if [ -f ".claude/project-manifest.json" ]; then
            echo "✅ project-manifest.json created by SessionStart hook"
            cat .claude/project-manifest.json
          else
            echo "⚠️  project-manifest.json not created (hook may not have triggered generate-manifest)"
          fi

          # Check if Claude mentioned anything about context-daddy or project context
          # The systemMessage goes to Claude's context, so Claude might reference it
          if grep -qi "context-daddy\|repo.map\|mcp\|symbol" session-start-output.txt; then
            echo "✅ Claude appears to have received context-daddy context"
          else
            echo "⚠️  Claude response doesn't mention context-daddy features"
          fi

          # Check for .claude directory (created by hook)
          if [ -d ".claude" ]; then
            echo "✅ .claude directory exists"
            ls -la .claude/
          else
            echo "❌ .claude directory not created"
            exit 1
          fi

      - name: Test PreCompact + Stop hooks via turn limit
        run: |
          cd test-hook-project
          echo "=== Testing PreCompact and Stop hooks ==="

          # Create large context to force compaction by hitting turn limit
          # With many turns and task complexity, compaction will eventually trigger
          # The Stop hook should block and force Claude to read CLAUDE.md

          # NOTE: We'll use --max-turns to force hitting the limit
          # which should trigger compaction
          claude --plugin-dir ${{ github.workspace }} \
            -p "Count from 1 to 50, one number per turn. Keep going until you reach 50 or hit the turn limit. If you hit a turn limit and see a context refresh message, read the files mentioned and acknowledge what you learned." \
            --max-turns 8 \
            --allowedTools "Read" \
            2>&1 | tee compact-test-output.txt

          # Check if PreCompact marker was created at some point
          # (it gets removed by Stop hook after use)
          echo "Checking for compaction indicators..."

          # Check if Claude's response mentions reading CLAUDE.md or learnings.md
          # This indicates Stop hook blocked and forced reorientation
          if grep -qi "CLAUDE.md\|learnings.md\|context refresh\|reorientation" compact-test-output.txt; then
            echo "✅ Stop hook likely fired - Claude mentioned reorientation files"
            grep -i "CLAUDE.md\|learnings.md\|context refresh" compact-test-output.txt | head -5
          else
            echo "⚠️  Stop hook may not have fired (no compaction might have occurred)"
            echo "This is not necessarily a failure - compaction may not have triggered"
          fi

          # Check if Claude read the CLAUDE.md file
          if grep -qi "test project\|hooks worked" compact-test-output.txt; then
            echo "✅ Claude read CLAUDE.md content (Stop hook forced reorientation)"
          fi

      - name: Verify hook artifacts
        run: |
          cd test-hook-project
          echo "=== Checking hook artifacts ==="

          # Check if repo-map was built
          if [ -f ".claude/repo-map.db" ]; then
            echo "✅ repo-map.db exists (SessionStart hook triggered indexing)"
            python3 -c "import sqlite3; c=sqlite3.connect('.claude/repo-map.db'); print(f'  Symbols: {c.execute(\"SELECT COUNT(*) FROM symbols\").fetchone()[0]}')"
          fi

          # Check for MCP server logs
          if [ -f ".claude/logs/repo-map-server.log" ]; then
            echo "✅ MCP server log exists"
            echo "  Last 5 log entries:"
            tail -5 .claude/logs/repo-map-server.log
          fi

      - name: Summary
        run: |
          echo ""
          echo "=== Hook Test Summary ==="
          echo "SessionStart hook: Verified via .claude directory and manifest creation"
          echo "PreCompact/Stop hooks: Tested via turn limit (may not trigger every time)"
          echo ""
          echo "To fully test compact flow locally:"
          echo "1. Install plugin locally: claude plugin install --dev ."
          echo "2. Start session and manually trigger /compact"
          echo "3. Verify you see 'Context Refresh Required' blocking message"
          echo "4. Verify Claude reads CLAUDE.md and learnings.md"
